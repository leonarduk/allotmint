
pipeline {
  agent any

  parameters {
    string(name: 'AI_INSTRUCTION', defaultValue: 'Refactor backend logging', description: 'Describe what you want the AI to do')
    string(name: 'TARGET_PATHS', defaultValue: 'backend frontend/src', description: 'Directories to include in AI context')
    choice(name: 'CHUNK_STRATEGY', choices: ['recent', 'size', 'directory', 'filetype'], description: 'Chunking strategy')
    string(name: 'MAX_CONTEXT_LINES', defaultValue: '800', description: 'Max lines per chunk (~20-25k tokens)')
    string(name: 'NUM_COMMITS', defaultValue: '10', description: 'For "recent" strategy: analyze last N commits')
  }

  environment {
    GITHUB_TOKEN = credentials('GITHUB_TOKEN')
    LM_API_BASE = 'http://host.docker.internal:1234'
    MODEL_NAME = 'Qwen2.5-Coder'
    OUTPUT_MODE = 'patch'  // or 'file'
    PROMPT_FILE = '.ci/prompt.md'
    AI_BRANCH = "ai-changes-${env.BUILD_NUMBER}"
    CHUNK_STRATEGY = "${params.CHUNK_STRATEGY}"
    MAX_CONTEXT_LINES = "${params.MAX_CONTEXT_LINES}"
    NUM_COMMITS = "${params.NUM_COMMITS}"
    TARGET_PATHS = "${params.TARGET_PATHS}"
    EXTRA_INSTRUCTION = "${params.AI_INSTRUCTION}"
  }

  options {
    timestamps()
    timeout(time: 30, unit: 'MINUTES')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[url: 'https://github.com/leonarduk/allotmint.git', credentialsId: 'GITHUB_TOKEN']]
        ])
      }
    }

    stage('Verify Prerequisites') {
      steps {
        sh '''
          echo "=== Checking required tools ==="
          git --version
          gh --version || echo "Warning: gh CLI not found"
          jq --version
          curl --version

          echo "=== Checking LM Studio ==="
          curl -sS "${LM_API_BASE}/v1/models" || {
            echo "ERROR: Cannot reach LM Studio at ${LM_API_BASE}"
            exit 1
          }
        '''
      }
    }

    stage('Setup Git and gh') {
      steps {
        sh '''
          git config user.name "jenkins-ai"
          git config user.email "jenkins-ai@local"
          gh auth status
        '''
      }
    }

    stage('Create AI Branch') {
      steps {
        sh '''
          git checkout -b "${AI_BRANCH}"
          echo "Created branch: ${AI_BRANCH}"
        '''
      }
    }

    stage('AI Code Generation') {
      steps {
        sh '''
          echo "=== Starting AI code generation with chunked strategy ==="
          chmod +x .ci/ai_apply_chunked.sh

          MODEL_NAME="$MODEL_NAME" \
          LM_API_BASE="$LM_API_BASE" \
          OUTPUT_MODE="$OUTPUT_MODE" \
          TARGET_PATHS="$TARGET_PATHS" \
          PROMPT_FILE="$PROMPT_FILE" \
          EXTRA_INSTRUCTION="$EXTRA_INSTRUCTION" \
          CHUNK_STRATEGY="$CHUNK_STRATEGY" \
          MAX_CONTEXT_LINES="$MAX_CONTEXT_LINES" \
          NUM_COMMITS="$NUM_COMMITS" \
            ./.ci/ai_apply_chunked.sh
        '''
      }
    }

    stage('Review Changes') {
      steps {
        sh '''
          echo "=== Changes made by AI ==="
          git status
          git diff --stat
          if ! git diff --quiet; then
            git diff --name-only
          else
            echo "No changes detected"
          fi
        '''
      }
    }

    stage('Validation') {
      steps {
        sh '''
          echo "=== Running validation checks ==="
          chmod +x .ci/validate.sh
          ./.ci/validate.sh
        '''
      }
    }

    stage('Commit Changes') {
      steps {
        sh '''
          if ! git diff --quiet; then
            git add -A
            git commit -m "AI-generated improvements via LM Studio (${MODEL_NAME})" \
                       -m "Generated by Jenkins build #${BUILD_NUMBER}" \
                       -m "Model: ${MODEL_NAME}" \
                       -m "Validation: All tests passed"
          else
            echo "No changes to commit"
          fi
        '''
      }
    }

    stage('Push Branch') {
      when {
        expression {
          return sh(script: 'git diff --quiet HEAD~1 HEAD 2>/dev/null || test $? -eq 1', returnStatus: true) == 0
        }
      }
      steps {
        sh '''
          echo "=== Pushing branch ${AI_BRANCH} ==="
          git push https://${GITHUB_TOKEN}@github.com/leonarduk/allotmint.git HEAD:${AI_BRANCH}
        '''
      }
    }

    stage('Create Pull Request') {
      when {
        expression {
          return sh(script: "git ls-remote --exit-code --heads origin ${env.AI_BRANCH}", returnStatus: true) == 0
        }
      }
      steps {
        sh '''
          PR_TITLE="ü§ñ AI Code Improvements (${MODEL_NAME})"
          PR_BODY="## AI-Generated Changes

This PR contains automated code improvements generated by LM Studio using **${MODEL_NAME}**.

### üîç Changes Made
- Improved error handling and logging
- Enhanced type safety
- Performance optimizations
- Better code quality

### ‚úÖ Validation
- All tests passed on Jenkins build #${BUILD_NUMBER}
- Linting checks passed
- No breaking changes to public APIs

Generated on: $(date)
Jenkins Build: #${BUILD_NUMBER}"

          gh pr create --base main --head "${AI_BRANCH}" --title "${PR_TITLE}" --body "${PR_BODY}" --label "ai-generated" --label "automated"
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: '.ci/**', allowEmptyArchive: true
      sh '''
        if [ -f .ci/context.txt ]; then echo "Context size: $(wc -l < .ci/context.txt) lines"; fi
        if [ -f .ci/ai_output.txt ]; then echo "AI output size: $(wc -l < .ci/ai_output.txt) lines"; fi
      '''
    }
    success {
      echo '‚úÖ AI pipeline completed successfully'
    }
    failure {
      echo '‚ùå Pipeline failed. Check LM Studio connectivity, model name, tests, and GitHub credentials.'
    }
  }
}
