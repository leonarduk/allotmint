# Smoke Tests

Run quick checks against critical backend endpoints and the frontend smoke test page after deployment.

## Environment variables

- `SMOKE_URL` – base URL of the deployment to exercise for both backend and
  frontend suites.
- `TEST_ID_TOKEN` – optional ID token added as a `Bearer` token for backend endpoints requiring authentication.
- `SMOKE_AUTH_TOKEN` – optional bearer token stored in the frontend's `localStorage`; falls back to `TEST_ID_TOKEN` when unset.
- `SMOKE_IDENTITY` – overrides the owner slug used for generated backend smoke
  requests (defaults to `auth.smoke_identity` from `config.yaml`).

If the backend is offline you'll see an error similar to:

```
Preflight check failed: could not reach http://localhost:8000/health (fetch failed). Start the backend (make run-backend) or provide SMOKE_URL pointing to a running instance.
```

Start the backend locally or point `SMOKE_URL` at an accessible deployment, then re-run the smoke tests.

## Usage

Run the backend and frontend suites together with a single command:

```bash
SMOKE_URL=https://example.com npm run smoke:test:all
```

Run only the backend API checks:

```bash
SMOKE_URL=https://example.com npm run smoke:test
```

Run only the frontend smoke page checks:

```bash
SMOKE_URL=https://example.com npm --prefix frontend run smoke:frontend
```

Include `TEST_ID_TOKEN` (and optionally `SMOKE_AUTH_TOKEN`) if the target
requires auth; the backend smoke runner forwards it as a bearer token:

```bash
SMOKE_URL=https://example.com TEST_ID_TOKEN=token npm run smoke:test:all
```

Each command exits non-zero if any check fails, allowing CI to fail fast.

The legacy `scripts/smoke-test.ps1` helper remains available: run it without arguments to execute the combined backend/frontend suites against the default local stack, provide one or more URLs via the `SMOKE_TEST_URLS` environment variable or as command-line arguments for simple HTTP 200 checks, or set `SMOKE_URL` to target a specific deployment when delegating to the autogenerated suites.
