pipeline {
  agent any

  parameters {
    choice(
      name: 'CHUNK_STRATEGY',
      choices: ['recent', 'size', 'directory', 'filetype'],
      description: 'How to split code into chunks: recent=git changes only, size=pack by size, directory=by folder, filetype=by extension'
    )
    string(
      name: 'MAX_CONTEXT_LINES',
      defaultValue: '800',
      description: 'Max lines per chunk (~20-25k tokens)'
    )
    string(
      name: 'NUM_COMMITS',
      defaultValue: '10',
      description: 'For "recent" strategy: analyze last N commits'
    )
  }

  environment {
    GITHUB_TOKEN = credentials('github_pat')
    LM_API_BASE = 'http://localhost:1234'
    MODEL_NAME  = 'Qwen2.5-Coder'
    OUTPUT_MODE = 'patch'
    TARGET_PATHS = 'backend frontend/src'
    PROMPT_FILE = '.ci/prompt.md'
    AI_BRANCH = "ai-changes-${env.BUILD_NUMBER}"
    
    // Chunking configuration from parameters
    CHUNK_STRATEGY = "${params.CHUNK_STRATEGY}"
    MAX_CONTEXT_LINES = "${params.MAX_CONTEXT_LINES}"
    NUM_COMMITS = "${params.NUM_COMMITS}"
  }

  options {
    timestamps()
    ansiColor('xterm')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: 'https://github.com/leonarduk/allotmint.git',
            credentialsId: 'github_pat'
          ]]
        ])
      }
    }

    stage('Setup gh and git') {
      steps {
        sh '''
          git config user.name "jenkins-ai"
          git config user.email "jenkins-ai@local"
          gh auth login --with-token <<< "$GITHUB_TOKEN"
          gh --version
          git --version
        '''
      }
    }

    stage('Create branch') {
      steps {
        sh '''
          git checkout -b "${AI_BRANCH}"
        '''
      }
    }

    stage('AI code generation') {
      steps {
        sh '''
          mkdir -p .ci
          echo "=== LM Studio Configuration ==="
          echo "API: ${LM_API_BASE}"
          echo "Model: ${MODEL_NAME}"
          echo "Strategy: ${CHUNK_STRATEGY}"
          echo "Max lines/chunk: ${MAX_CONTEXT_LINES}"
          
          # Make scripts executable
          chmod +x .ci/ai_apply.sh
          
          # Run AI generation with chunking
          ./.ci/ai_apply.sh
        '''
      }
    }

    stage('Validation') {
      steps {
        sh '''
          chmod +x .ci/validate.sh
          ./.ci/validate.sh
        '''
      }
    }

    stage('Commit changes') {
      steps {
        sh '''
          if ! git diff --quiet; then
            git add -A
            git commit -m "AI-generated changes via LM Studio (${MODEL_NAME}, strategy: ${CHUNK_STRATEGY})"
          else
            echo "No changes detected; skipping commit."
          fi
        '''
      }
    }

    stage('Push branch') {
      when {
        expression { return sh(script: 'git rev-parse --verify HEAD >/dev/null 2>&1', returnStatus: true) == 0 }
      }
      steps {
        sh '''
          git push https://$GITHUB_TOKEN@github.com/leonarduk/allotmint.git HEAD:${AI_BRANCH}
        '''
      }
    }

    stage('Create PR') {
      when {
        expression { return sh(script: 'git ls-remote --exit-code --heads origin ' + env.AI_BRANCH, returnStatus: true) == 0 }
      }
      steps {
        sh '''
          PR_TITLE="AI Update: ${MODEL_NAME} (${CHUNK_STRATEGY} strategy)"
          PR_BODY="$(printf "Automated changes generated by LM Studio.\\n\\nModel: %s\\nChunking strategy: %s\\nMax context: %s lines\\nValidation: passed on Jenkins build #%s" "${MODEL_NAME}" "${CHUNK_STRATEGY}" "${MAX_CONTEXT_LINES}" "${BUILD_NUMBER}")"

          gh pr create \
            --base main \
            --head "${AI_BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" || {
              echo "PR creation failed; verify gh auth and permissions."
              exit 1
            }

          gh pr view --web || true
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: '.ci/**', allowEmptyArchive: true
    }
    success {
      echo "Pipeline succeeded! Check PR for AI-generated changes."
    }
    failure {
      echo 'Pipeline failed. Check LM Studio server, model output format, and project tests.'
    }
  }
}
