"""Backend application entry-point.

This module exposes :func:`create_app`, a small factory that builds and
configures the FastAPI instance used by both the local development server
(`uvicorn`) and the AWS Lambda handler. Keeping the setup in a function makes
it easy for tests to create isolated apps and mirrors the pattern recommended
by FastAPI.
"""

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from backend.routes.instrument import router as instrument_router
from backend.routes.portfolio import router as portfolio_router
from backend.routes.timeseries_meta import router as timeseries_router
from backend.routes.timeseries_edit import router as timeseries_edit_router

from backend.routes.transactions import router as transactions_router
from backend.routes.alerts import router as alerts_router
from backend.routes.compliance import router as compliance_router
from backend.routes.screener import router as screener_router
from backend.routes.support import router as support_router
from backend.routes.query import router as query_router
from backend.routes.virtual_portfolio import router as virtual_portfolio_router
from backend.routes.trading_agent import router as trading_agent_router
from backend.routes.config import router as config_router
from backend.common.portfolio_utils import refresh_snapshot_in_memory_from_timeseries
from backend.config import config


def create_app() -> FastAPI:
    """Create and configure the FastAPI application.

    The function wires together middleware, registers routers and primes the
    in-memory price snapshot so the first request is quick. Returning the app
    instance instead of creating it at module import time keeps things
    test-friendly and avoids accidental state sharing between invocations.
    """

    # The FastAPI constructor accepts a few descriptive fields that end up in
    # the autogenerated OpenAPI/Swagger documentation.
    app = FastAPI(title="Allotmint API", version="1.0", docs_url="/docs")

    # ───────────────────────────── CORS ─────────────────────────────
    # During development the frontend often runs on a different origin. We
    # therefore allow every origin/method/header. A production deployment
    # should tighten these values.
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_methods=["*"],
        allow_headers=["*"],
    )

    # ──────────────────────────── Routers ────────────────────────────
    # The API surface is composed of a few routers grouped by concern.
    # They are registered here on the main application instance.
    app.include_router(portfolio_router)
    app.include_router(instrument_router)
    app.include_router(timeseries_router)
    app.include_router(timeseries_edit_router)
    app.include_router(transactions_router)
    app.include_router(alerts_router)
    app.include_router(compliance_router)
    app.include_router(screener_router)
    app.include_router(support_router)
    app.include_router(query_router)
    app.include_router(virtual_portfolio_router)
    app.include_router(trading_agent_router)
    app.include_router(config_router)

    # ────────────────────── Health-check endpoint ─────────────────────
    @app.get("/health")
    async def health():
        """Return a small payload used by tests and uptime monitors."""

        return {"status": "ok", "env": config.app_env or "test"}

    # ─────────────── Warm the price snapshot on startup ───────────────
    skip_warm = bool(config.skip_snapshot_warm)

    if not skip_warm:
        @app.on_event("startup")
        async def _warm_snapshot():
            """Pre-fetch recent price data so the first request is fast."""

            refresh_snapshot_in_memory_from_timeseries(
                days=config.snapshot_warm_days or 30
            )

    return app


# optional local test:  python -m backend.app
if __name__ == "__main__":
    import uvicorn

    uvicorn.run(
        create_app(), host="0.0.0.0", port=config.uvicorn_port or 8000
    )
