pipeline {
  agent any

  parameters {
    string(name: 'AI_INSTRUCTION',
           defaultValue: 'Refactor backend logging',
           description: 'Describe what you want the AI to do')

        // Add a string parameter for target paths
        string(
            name: 'TARGET_PATHS',
            defaultValue: 'frontend',
            description: 'Directories to include in AI context (e.g. frontend, backend, frontend/src)'
        )

  }

  environment {
    // GitHub credentials
    GITHUB_TOKEN = credentials('GITHUB_TOKEN')

    // LM Studio configuration
    LM_API_BASE = 'http://host.docker.internal:1234'
    MODEL_NAME  = 'Qwen2.5-Coder'
    OUTPUT_MODE = 'patch'  // or 'file'
    PROMPT_FILE = '.ci/prompt.md'

    // Branch naming
    AI_BRANCH = "ai-changes-${env.BUILD_NUMBER}"
  }

  options {
    timestamps()
    timeout(time: 30, unit: 'MINUTES')
  }

  stages {
    stage('Checkout') {
      steps {
        checkout([$class: 'GitSCM',
          branches: [[name: '*/main']],
          userRemoteConfigs: [[
            url: 'https://github.com/leonarduk/allotmint.git',
            credentialsId: 'GITHUB_TOKEN'
          ]]
        ])
      }
    }

    stage('Verify Prerequisites') {
      steps {
        sh '''
          echo "=== Checking required tools ==="
          git --version
          gh --version || echo "Warning: gh CLI not found"
          jq --version
          curl --version

          echo "=== Checking LM Studio ==="
          curl -sS "${LM_API_BASE}/v1/models" || {
            echo "ERROR: Cannot reach LM Studio at ${LM_API_BASE}"
            echo "Make sure LM Studio is running with local server enabled"
            exit 1
          }
        '''
      }
    }

    stage('Setup Git and gh') {
      steps {
        sh '''
          git config user.name "jenkins-ai"
          git config user.email "jenkins-ai@local"

          # Authenticate gh with token
          gh auth status
        '''
      }
    }

    stage('Create AI Branch') {
      steps {
        sh '''
          git checkout -b "${AI_BRANCH}"
          echo "Created branch: ${AI_BRANCH}"
        '''
      }
    }

    stage('AI Code Generation') {
      steps {
        sh '''
          echo "=== Starting AI code generation ==="
          echo "Model: ${MODEL_NAME}"
          echo "API Base: ${LM_API_BASE}"
          echo "Target paths: ${TARGET_PATHS}"
          echo "Output mode: ${OUTPUT_MODE}"

          chmod +x .ci/ai_apply.sh

              MODEL_NAME="$MODEL_NAME" \
              LM_API_BASE="$LM_API_BASE" \
              OUTPUT_MODE="$OUTPUT_MODE" \
              TARGET_PATHS="$TARGET_PATHS" \
              PROMPT_FILE="$PROMPT_FILE" \

            ./.ci/ai_apply.sh
        '''
      }
    }

    stage('Review Changes') {
      steps {
        sh '''
          echo "=== Changes made by AI ==="
          git status
          git diff --stat

          if ! git diff --quiet; then
            echo "Files modified:"
            git diff --name-only
          else
            echo "No changes detected"
          fi
        '''
      }
    }

    stage('Validation') {
      steps {
        sh '''
          echo "=== Running validation checks ==="
          chmod +x .ci/validate.sh
          ./.ci/validate.sh
        '''
      }
    }

    stage('Commit Changes') {
      steps {
        sh '''
          if ! git diff --quiet; then
            git add -A
            git commit -m "AI-generated improvements via LM Studio (${MODEL_NAME})" \
                       -m "Generated by Jenkins build #${BUILD_NUMBER}" \
                       -m "Model: ${MODEL_NAME}" \
                       -m "Validation: All tests passed"
            echo "Changes committed"
          else
            echo "No changes to commit"
          fi
        '''
      }
    }

    stage('Push Branch') {
      when {
        expression {
          return sh(
            script: 'git diff --quiet HEAD~1 HEAD 2>/dev/null || test $? -eq 1',
            returnStatus: true
          ) == 0
        }
      }
      steps {
        sh '''
          echo "=== Pushing branch ${AI_BRANCH} ==="
          git push https://${GITHUB_TOKEN}@github.com/leonarduk/allotmint.git HEAD:${AI_BRANCH}
          echo "Branch pushed successfully"
        '''
      }
    }

    stage('Create Pull Request') {
      when {
        expression {
          return sh(
            script: "git ls-remote --exit-code --heads origin ${env.AI_BRANCH}",
            returnStatus: true
          ) == 0
        }
      }
      steps {
        sh '''
          PR_TITLE="ü§ñ AI Code Improvements (${MODEL_NAME})"
          PR_BODY="## AI-Generated Changes

This PR contains automated code improvements generated by LM Studio using **${MODEL_NAME}**.

### üîç Changes Made
- Improved error handling and logging
- Enhanced type safety
- Performance optimizations
- Better code quality

### ‚úÖ Validation
- All tests passed on Jenkins build #${BUILD_NUMBER}
- Linting checks passed
- No breaking changes to public APIs

### üìä Review Notes
Please review the changes carefully. The AI focused on surgical improvements without wholesale rewrites.

Generated on: $(date)
Jenkins Build: #${BUILD_NUMBER}"

          gh pr create \
            --base main \
            --head "${AI_BRANCH}" \
            --title "${PR_TITLE}" \
            --body "${PR_BODY}" \
            --label "ai-generated" \
            --label "automated" || {
              echo "PR creation failed; verify gh auth and permissions"
              exit 1
            }

          echo "=== Pull Request Created ==="
          gh pr view --web || gh pr view
        '''
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: '.ci/**', allowEmptyArchive: true
      sh '''
        if [ -f .ci/context.txt ]; then
          echo "Context size: $(wc -l < .ci/context.txt) lines"
        fi
        if [ -f .ci/ai_output.txt ]; then
          echo "AI output size: $(wc -l < .ci/ai_output.txt) lines"
        fi
      '''
    }
    success {
      echo '‚úÖ AI pipeline completed successfully'
    }
    failure {
      echo '‚ùå Pipeline failed. Check:'
      echo '  1. LM Studio is running and accessible'
      echo '  2. Model name is correct'
      echo '  3. Tests pass locally'
      echo '  4. GitHub credentials are valid'
    }
  }
}
